# Story 1.10: Enhance Unit Test Infrastructure

## Status
Draft

## Story

**As a** developer,
**I want** to enhance the unit test infrastructure with comprehensive coverage requirements,
**so that** business logic is thoroughly tested and regressions are prevented.

## Acceptance Criteria

1. **Given** Jest is already configured in the project
2. **When** I enhance the unit test infrastructure
3. **Then** the following are established:
   - Test coverage requirements defined (services: 100%, utilities: 100%, reducers: 100%)
   - Test organization patterns documented (`src/**/__tests__/`)
   - Mock patterns established for database and haptics
   - Test execution scripts configured (`pnpm test`, `pnpm test:coverage`)
   - Coverage reporting configured
4. **And** all service functions have unit tests with 100% coverage
5. **And** all utility functions have unit tests with 100% coverage
6. **And** all reducer actions have unit tests with 100% coverage
7. **And** tests follow Arrange-Act-Assert pattern
8. **And** tests have descriptive names explaining what is tested
9. **And** test execution time is fast (< 5 seconds for all unit tests)

**FRs covered:** NFR22, NFR23, NFR24, NFR31, NFR32

## Tasks / Subtasks

- [ ] Define test coverage requirements (AC: 3)
  - [ ] Document coverage targets: services 100%, utilities 100%, reducers 100%
  - [ ] Update testing strategy documentation with coverage requirements
  - [ ] Configure coverage thresholds in Jest configuration
- [ ] Document test organization patterns (AC: 3)
  - [ ] Document `src/**/__tests__/` pattern for test file location
  - [ ] Document test file naming convention (`.test.ts` or `.test.tsx`)
  - [ ] Create examples of test organization structure
- [ ] Establish mock patterns (AC: 3)
  - [ ] Create mock utilities for database operations
  - [ ] Create mock utilities for haptic feedback
  - [ ] Document mock patterns in testing guidelines
  - [ ] Create example mocks for common scenarios
- [ ] Configure test execution scripts (AC: 3)
  - [ ] Verify `pnpm test` script works correctly
  - [ ] Add `pnpm test:coverage` script for coverage reports
  - [ ] Add `pnpm test:watch` script for watch mode
  - [ ] Document test execution commands
- [ ] Configure coverage reporting (AC: 3)
  - [ ] Configure Jest coverage collection
  - [ ] Set up coverage report generation (HTML, text, JSON)
  - [ ] Configure coverage thresholds in jest.config.js
  - [ ] Document how to view coverage reports
- [ ] Verify service test coverage (AC: 4)
  - [ ] Review existing service tests (gameRules, database, haptics)
  - [ ] Ensure 100% coverage for all service functions
  - [ ] Add missing test cases to reach 100% coverage
  - [ ] Verify edge cases and error scenarios are tested
- [ ] Verify utility test coverage (AC: 5)
  - [ ] Review existing utility tests (validation, formatting, platform, accessibility)
  - [ ] Ensure 100% coverage for all utility functions
  - [ ] Add missing test cases to reach 100% coverage
  - [ ] Verify edge cases are tested
- [ ] Verify reducer test coverage (AC: 6)
  - [ ] Review existing reducer tests (gameReducer)
  - [ ] Ensure 100% coverage for all reducer actions
  - [ ] Add missing test cases to reach 100% coverage
  - [ ] Verify state immutability in all tests
- [ ] Establish test patterns (AC: 7, 8)
  - [ ] Document Arrange-Act-Assert pattern
  - [ ] Create test template examples
  - [ ] Document test naming conventions
  - [ ] Create examples of descriptive test names
- [ ] Verify test performance (AC: 9)
  - [ ] Run full unit test suite and measure execution time
  - [ ] Optimize slow tests if needed
  - [ ] Ensure total execution time is < 5 seconds
  - [ ] Document test performance expectations

## Dev Notes

### Project Context
This story enhances the existing Jest unit test infrastructure to establish comprehensive coverage requirements and testing patterns. It ensures all business logic (services, utilities, reducers) is thoroughly tested to prevent regressions.

### Source Tree Information
- **Test files**: `src/**/__tests__/*.test.ts` or `*.test.tsx`
- **Jest config**: `jest.config.js`
- **Test setup**: `jest.setup.js`
- **Coverage reports**: `coverage/` directory (gitignored)

### Architecture References
- **Testing Strategy**: See `docs/architecture/testing-strategy.md`
- **Jest Configuration**: Already configured with `jest-expo` preset
- **Test Organization**: Tests co-located with source files in `__tests__/` directories
- **Coverage Requirements**: Services 100%, Utilities 100%, Reducers 100%

### Technical Implementation Notes

**Jest Configuration Updates:**
```javascript
// jest.config.js
module.exports = {
  preset: 'jest-expo',
  collectCoverageFrom: [
    'src/services/**/*.{ts,tsx}',
    'src/utils/**/*.{ts,tsx}',
    'src/reducers/**/*.{ts,tsx}',
    '!**/*.d.ts',
    '!**/__tests__/**',
  ],
  coverageThresholds: {
    global: {
      branches: 100,
      functions: 100,
      lines: 100,
      statements: 100,
    },
  },
};
```

**Package.json Scripts:**
```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:ci": "jest --ci --coverage --maxWorkers=2"
  }
}
```

**Mock Patterns:**
```typescript
// Example: Mock database service
jest.mock('../services/database', () => ({
  createGame: jest.fn(),
  getGame: jest.fn(),
  // ... other functions
}));

// Example: Mock haptics service
jest.mock('../services/haptics', () => ({
  triggerScoreEntry: jest.fn(),
  triggerPenalty: jest.fn(),
  // ... other functions
}));
```

**Test Pattern Example:**
```typescript
// Arrange-Act-Assert pattern
describe('gameRules.checkPenaltyRule', () => {
  it('should return true when score exceeds 50', () => {
    // Arrange
    const score = 51;
    
    // Act
    const result = checkPenaltyRule(score);
    
    // Assert
    expect(result).toBe(true);
  });
});
```

### Dependencies
- Jest already configured in project
- `@testing-library/jest-native` already installed
- No additional dependencies required

### Testing Requirements
- Verify all service functions have unit tests
- Verify all utility functions have unit tests
- Verify all reducer actions have unit tests
- Verify coverage reports show 100% for services, utilities, reducers
- Verify test execution time is < 5 seconds

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-15 | 1.0 | Story created from Epic 1 | Architect Agent |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
