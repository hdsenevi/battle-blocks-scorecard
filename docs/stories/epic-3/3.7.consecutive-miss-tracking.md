# Story 3.7: Consecutive Miss Tracking

## Status
Draft

## Story

**As a** user,
**I want** the system to track consecutive misses for each player,
**so that** elimination rules can be enforced automatically (foundation for Epic 4).

## Acceptance Criteria

1. **Given** a player misses all target pins (enters score of 0)
2. **When** the score entry is processed
3. **Then** the player's consecutive_misses counter is incremented
4. **And** the consecutive_misses value is stored in the database
5. **And** the consecutive_misses value is tracked in the game state
6. **And** if a player scores points (non-zero), their consecutive_misses is reset to 0
7. **And** the tracking happens automatically without user intervention
8. **And** the data is available for the elimination rule logic (Epic 4, Story 4.2)

**FRs covered:** FR15, FR18

## Tasks / Subtasks

- [ ] Detect score of 0 (miss) (AC: 1, 2)
  - [ ] Check if score entry is 0
  - [ ] Identify this as a miss
- [ ] Increment consecutive_misses (AC: 3)
  - [ ] Increment player's consecutive_misses counter
  - [ ] Update in game state
- [ ] Save to database (AC: 4)
  - [ ] Update player's consecutive_misses in database
  - [ ] Use database service updatePlayer()
- [ ] Update game state (AC: 5)
  - [ ] Update consecutive_misses in GameContext
  - [ ] Ensure state sync with database
- [ ] Reset on non-zero score (AC: 6)
  - [ ] Detect when player scores non-zero points
  - [ ] Reset consecutive_misses to 0
  - [ ] Update database and game state
- [ ] Ensure automatic tracking (AC: 7)
  - [ ] No user intervention required
  - [ ] Tracking happens during score entry processing
- [ ] Make data available for elimination rule (AC: 8)
  - [ ] Ensure consecutive_misses is accessible
  - [ ] Available for checkElimination() function (Story 4.2)

## Dev Notes

### Project Context
This story implements consecutive miss tracking, which is the foundation for the elimination rule in Epic 4. When a player scores 0, their consecutive_misses counter increments.

### Source Tree Information
- **Score entry processing**: In score entry components (Stories 3.2, 3.3)
- **Database service**: `services/database.ts` - updatePlayer() function
- **Game Context**: `contexts/GameContext.tsx` - consecutive_misses in state
- **Game Reducer**: `reducers/gameReducer.ts` - May need action for updating consecutive_misses

### Architecture References
- **Miss Detection**: Score of 0 = miss
- **Counter Increment**: consecutive_misses++ on miss
- **Counter Reset**: consecutive_misses = 0 on non-zero score
- **Database Storage**: Stored in players table consecutive_misses column
- **State Management**: Tracked in GameContext

### Dependencies
- Requires Story 1.3 (Database Service) to be completed
- Requires Story 1.6 (Game Context) to be completed
- Integrates with Stories 3.2 and 3.3 (Score entry)
- Foundation for Story 4.2 (Elimination Rule)

### Testing

**Test File Location:**
- Integration tests for score entry with miss tracking
- `services/__tests__/database.test.ts` - Database update tests

**Test Standards:**
- Test consecutive_misses increment on score of 0
- Test consecutive_misses reset on non-zero score
- Test database save for consecutive_misses
- Test game state update
- Test automatic tracking
- Mock database service

**Testing Frameworks:**
- Jest for unit testing
- React Native Testing Library for component testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Story created from Epic 3 | PM Agent |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
