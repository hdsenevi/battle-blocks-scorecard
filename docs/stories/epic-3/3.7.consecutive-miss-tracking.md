# Story 3.7: Consecutive Miss Tracking

## Status
Ready for Review

## Story

**As a** user,
**I want** the system to track consecutive misses for each player,
**so that** elimination rules can be enforced automatically (foundation for Epic 4).

## Acceptance Criteria

1. **Given** a player misses all target pins (enters score of 0)
2. **When** the score entry is processed
3. **Then** the player's consecutive_misses counter is incremented
4. **And** the consecutive_misses value is stored in the database
5. **And** the consecutive_misses value is tracked in the game state
6. **And** if a player scores points (non-zero), their consecutive_misses is reset to 0
7. **And** the tracking happens automatically without user intervention
8. **And** the data is available for the elimination rule logic (Epic 4, Story 4.2)

**FRs covered:** FR15, FR18

## Tasks / Subtasks

- [x] Detect score of 0 (miss) (AC: 1, 2)
  - [x] Check if score entry is 0 (value === 0 check in ScoreEntryModal)
  - [x] Identify this as a miss (handled separately from non-zero scores)
- [x] Increment consecutive_misses (AC: 3)
  - [x] Increment player's consecutive_misses counter (newConsecutiveMisses = player.consecutive_misses + 1)
  - [x] Update in game state (dispatch(updatePlayerAction(updatedPlayer)))
- [x] Save to database (AC: 4)
  - [x] Update player's consecutive_misses in database (updatePlayer with consecutive_misses)
  - [x] Use database service updatePlayer() (database service function)
- [x] Update game state (AC: 5)
  - [x] Update consecutive_misses in GameContext (updatePlayerAction dispatches to context)
  - [x] Ensure state sync with database (database updated first, then context)
- [x] Reset on non-zero score (AC: 6)
  - [x] Detect when player scores non-zero points (value !== 0 in ScoreEntryModal)
  - [x] Reset consecutive_misses to 0 (consecutive_misses: 0 in updatePlayer)
  - [x] Update database and game state (updatePlayer updates both)
- [x] Ensure automatic tracking (AC: 7)
  - [x] No user intervention required (automatic during score entry processing)
  - [x] Tracking happens during score entry processing (handled in handleSubmit)
- [x] Make data available for elimination rule (AC: 8)
  - [x] Ensure consecutive_misses is accessible (stored in player object, accessible via GameContext)
  - [x] Available for checkElimination() function (Story 4.2) (player.consecutive_misses available)

## Dev Notes

### Project Context
This story implements consecutive miss tracking, which is the foundation for the elimination rule in Epic 4. When a player scores 0, their consecutive_misses counter increments.

### Source Tree Information
- **Score entry processing**: In score entry components (Stories 3.2, 3.3)
- **Database service**: `services/database.ts` - updatePlayer() function
- **Game Context**: `contexts/GameContext.tsx` - consecutive_misses in state
- **Game Reducer**: `reducers/gameReducer.ts` - May need action for updating consecutive_misses

### Architecture References
- **Miss Detection**: Score of 0 = miss
- **Counter Increment**: consecutive_misses++ on miss
- **Counter Reset**: consecutive_misses = 0 on non-zero score
- **Database Storage**: Stored in players table consecutive_misses column
- **State Management**: Tracked in GameContext

### Dependencies
- Requires Story 1.3 (Database Service) to be completed
- Requires Story 1.6 (Game Context) to be completed
- Integrates with Stories 3.2 and 3.3 (Score entry)
- Foundation for Story 4.2 (Elimination Rule)

### Testing

**Test File Location:**
- Integration tests for score entry with miss tracking
- `services/__tests__/database.test.ts` - Database update tests

**Test Standards:**
- Test consecutive_misses increment on score of 0
- Test consecutive_misses reset on non-zero score
- Test database save for consecutive_misses
- Test game state update
- Test automatic tracking
- Mock database service

**Testing Frameworks:**
- Jest for unit testing
- React Native Testing Library for component testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Story created from Epic 3 | PM Agent |
| 2026-01-18 | 1.1 | Implementation verified, tests and Maestro flow added | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (Auto)

### Debug Log References
None

### Completion Notes List
- All story requirements have been implemented and verified
- Consecutive miss tracking implemented in ScoreEntryModal component:
  - Detects score of 0 (miss) - value === 0 check in handleSubmit
  - Increments consecutive_misses counter (newConsecutiveMisses = player.consecutive_misses + 1)
  - Saves to database via updatePlayer() with consecutive_misses value
  - Updates game state via updatePlayerAction dispatch
  - Resets consecutive_misses to 0 on non-zero score (consecutive_misses: 0 in updatePlayer for non-zero scores)
  - Tracking happens automatically during score entry processing (no user intervention required)
  - Data available for elimination rule logic (player.consecutive_misses accessible via GameContext)
- Miss handling flow:
  - When value === 0, increments consecutive_misses
  - Updates database with new consecutive_misses value
  - Dispatches updatePlayerAction to update GameContext
  - Shows alert with consecutive miss count
  - Checks for elimination (3 consecutive misses) - Story 4.2
- Non-zero score handling:
  - When value !== 0, resets consecutive_misses to 0
  - Updates database with consecutive_misses: 0
  - Dispatches updatePlayerAction to update GameContext
  - Normal score entry flow continues
- Automatic tracking:
  - No user intervention required
  - Tracking happens automatically during score entry processing in handleSubmit
  - Miss detection and counter increment happen seamlessly
- Data availability:
  - consecutive_misses stored in database (players table)
  - consecutive_misses tracked in GameContext (player object)
  - Available for checkElimination() function (Story 4.2)
- Maestro E2E test flow created:
  - Flow file: `.maestro/flows/consecutive-miss-tracking.yaml`
  - Tests all acceptance criteria: game creation, player addition, miss entry (score of 0), consecutive miss tracking, reset on non-zero score
  - Verifies consecutive_misses is incremented on miss
  - Verifies consecutive_misses is reset on non-zero score
  - Verifies tracking happens automatically
- All acceptance criteria met and verified through implementation

### File List
- `src/components/game/ScoreEntryModal.tsx` - Consecutive miss tracking implementation (already existed, verified)
- `src/services/database.ts` - updatePlayer() function for consecutive_misses storage (already existed, verified)
- `src/contexts/GameContext.tsx` - GameContext for consecutive_misses state tracking (already existed, verified)
- `src/reducers/gameReducer.ts` - UPDATE_PLAYER action for consecutive_misses state updates (already existed, verified)
- `.maestro/flows/consecutive-miss-tracking.yaml` - Maestro E2E test flow for consecutive miss tracking (NEW)

## QA Results
_To be populated by QA Agent_
