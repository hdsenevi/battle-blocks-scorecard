# Story 1.6: Set Up React Context State Management

## Status
Draft

## Story

**As a** developer,
**I want** to create GameContext with useReducer for game state management,
**so that** game state is centralized and can be accessed throughout the app.

## Acceptance Criteria

1. **Given** React Context and useReducer are available
2. **When** I set up the state management
3. **Then** the following are created:
   - `contexts/GameContext.tsx` with GameProvider component
   - `reducers/gameReducer.ts` with game state reducer
   - Type-safe action creators for state mutations
   - State structure includes: currentGame, players, gameStatus, leader
4. **And** the GameProvider wraps the app in the root layout
5. **And** state updates are immutable (never mutate existing state)
6. **And** the reducer handles actions: START_GAME, ADD_PLAYER, ADD_SCORE, APPLY_PENALTY, ELIMINATE_PLAYER, COMPLETE_GAME, RESUME_GAME
7. **And** TypeScript types are defined for GameState, GameAction, and all action payloads
8. **And** the context provides hooks for accessing state and dispatching actions

**FRs covered:** FR4, FR11, FR12, FR13, FR24, FR25

## Tasks / Subtasks

- [x] Define TypeScript types for state management (AC: 7)
  - [x] Create GameState interface with currentGame, players, gameStatus, leader
  - [x] Create GameAction type with action types
  - [x] Create action payload types for each action
- [x] Create gameReducer.ts (AC: 3, 5, 6)
  - [x] Create `reducers/gameReducer.ts`
  - [x] Implement reducer function with all action handlers
  - [x] Implement START_GAME action handler
  - [x] Implement ADD_PLAYER action handler
  - [x] Implement ADD_SCORE action handler
  - [x] Implement APPLY_PENALTY action handler
  - [x] Implement ELIMINATE_PLAYER action handler
  - [x] Implement COMPLETE_GAME action handler
  - [x] Implement RESUME_GAME action handler
  - [x] Ensure all state updates are immutable
- [x] Create GameContext.tsx (AC: 3, 8)
  - [x] Create `contexts/GameContext.tsx`
  - [x] Create GameProvider component with useReducer
  - [x] Provide state and dispatch through context
  - [x] Create custom hooks for accessing state and dispatch
- [x] Integrate GameProvider in root layout (AC: 4)
  - [x] Wrap app in GameProvider in `app/_layout.tsx`
  - [x] Ensure provider is at root level
- [x] Create action creators (AC: 3)
  - [x] Create type-safe action creator functions
  - [x] Export action creators for use in components

## Dev Notes

### Project Context
This story sets up the centralized state management for the game. All game state will be managed through React Context and useReducer pattern, providing a single source of truth.

### Source Tree Information
- **Game Context**: `contexts/GameContext.tsx` - React Context provider for game state
- **Game Reducer**: `reducers/gameReducer.ts` - Reducer function for game state updates
- **Test files**: 
  - `contexts/__tests__/GameContext.test.tsx` - Context tests
  - `reducers/__tests__/gameReducer.test.ts` - Reducer tests
- **Root layout**: `app/_layout.tsx` - Root layout where GameProvider is integrated

### Architecture References
- **State Management**: React Context + useReducer pattern
- **Context Location**: `contexts/GameContext.tsx`
- **Reducer Location**: `reducers/gameReducer.ts`
- **Immutability**: All state updates must be immutable (never mutate existing state)
- **Type Safety**: TypeScript types for GameState, GameAction, and action payloads
- **Action Types**: START_GAME, ADD_PLAYER, ADD_SCORE, APPLY_PENALTY, ELIMINATE_PLAYER, COMPLETE_GAME, RESUME_GAME

### State Structure
- **currentGame**: Current game instance data
- **players**: Array of players in the current game
- **gameStatus**: Status of the game (active/completed/paused)
- **leader**: Current leader/winner information

### Dependencies
- Uses React Context and useReducer (built-in React hooks)
- Will integrate with database service (Story 1.3) in future stories

### Testing

**Test File Location:**
- `contexts/__tests__/GameContext.test.tsx` - GameContext tests
- `reducers/__tests__/gameReducer.test.ts` - GameReducer tests

**Test Standards:**
- Test GameProvider provides state and dispatch
- Test all reducer actions (START_GAME, ADD_PLAYER, ADD_SCORE, etc.)
- Test state immutability (verify new objects created, not mutated)
- Test custom hooks for accessing state
- Test edge cases (empty state, invalid actions, etc.)
- Test action creators return correct action objects

**Testing Frameworks:**
- Jest for unit testing
- React Testing Library for context testing
- Mock React Context for isolated reducer testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Story created from Epic 1 | PM Agent |
| 2026-01-14 | 1.1 | Story implementation completed - all state management, context, reducer, and tests | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None

### Completion Notes List
- All story requirements have been implemented and verified
- TypeScript types defined: GameState interface with currentGame, players, gameStatus, leader
- GameAction type with all action types and payload types
- Game reducer created at `reducers/gameReducer.ts` with all action handlers:
  - START_GAME: Sets current game and resets players
  - ADD_PLAYER: Adds player to array and updates leader
  - ADD_SCORE: Adds score to player, resets consecutive misses, updates leader
  - APPLY_PENALTY: Applies penalty to player score
  - ELIMINATE_PLAYER: Marks player as eliminated
  - UPDATE_PLAYER: Updates player in array
  - COMPLETE_GAME: Sets game status to completed with winner
  - RESUME_GAME: Restores game state from saved data
  - RESET_GAME: Resets state to initial state
- Leader calculation logic implemented: finds highest scoring active player, returns null on ties
- All state updates are immutable (verified in tests)
- GameContext created at `contexts/GameContext.tsx` with GameProvider component
- Custom hooks provided: useGameContext(), useGameState(), useGameDispatch()
- GameProvider integrated in root layout (`app/_layout.tsx`) at root level
- Action creators created at `reducers/actionCreators.ts` with type-safe functions for all actions
- Comprehensive test suite created:
  - `reducers/__tests__/gameReducer.test.ts` - Tests all reducer actions and immutability
  - `contexts/__tests__/GameContext.test.tsx` - Tests context provider and hooks
- Tests verify state immutability (original state not mutated)
- Tests verify leader calculation (including ties and eliminated players)
- Linting passes with no errors

### File List
- `reducers/gameReducer.ts` - Game state reducer with all action handlers
- `reducers/actionCreators.ts` - Type-safe action creator functions
- `contexts/GameContext.tsx` - React Context provider and custom hooks
- `app/_layout.tsx` - Root layout with GameProvider integration
- `reducers/__tests__/gameReducer.test.ts` - Comprehensive reducer tests
- `contexts/__tests__/GameContext.test.tsx` - Comprehensive context tests

## QA Results
_To be populated by QA Agent_
