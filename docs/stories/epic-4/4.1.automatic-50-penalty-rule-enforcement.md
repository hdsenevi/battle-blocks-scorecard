# Story 4.1: Automatic 50+ Penalty Rule Enforcement

## Status
Draft

## Story

**As a** user,
**I want** the 50+ penalty rule to enforce automatically when my score exceeds 50,
**so that** I don't need to manually calculate or remember the penalty.

## Acceptance Criteria

1. **Given** a player's score is being updated (Stories 3.2, 3.3)
2. **When** the new score would exceed 50 points
3. **Then** the system automatically detects this using checkPenaltyRule() (Story 1.4)
4. **And** the player's score is automatically reset to 25
5. **And** the score reset is saved to the database
6. **And** clear visual feedback is provided:
   - Score animation showing the reset (e.g., 52 → 25)
   - Visual indicator (e.g., orange color, icon, or notification)
   - Clear message explaining what happened ("Score exceeded 50, reset to 25")
7. **And** strong haptic feedback is triggered (triggerPenalty() from Story 1.5)
8. **And** the visual feedback appears immediately when the rule triggers (NFR8)
9. **And** the penalty enforcement is 100% accurate (NFR22, NFR24)
10. **And** the rule enforcement happens in real-time without perceptible delay (NFR5)
11. **And** all players can see the penalty was applied on the main game screen

**FRs covered:** FR16, FR17, FR33, FR35, NFR5, NFR8, NFR22, NFR24

## Tasks / Subtasks

- [ ] Implement penalty detection (AC: 2, 3)
  - [ ] Check score after update using checkPenaltyRule() from gameRules service
  - [ ] Detect when score exceeds 50
- [ ] Implement score reset (AC: 4, 5)
  - [ ] Reset player score to 25
  - [ ] Update player in database
  - [ ] Update GameContext state
- [ ] Create visual feedback (AC: 6, 8)
  - [ ] Add score animation (52 → 25)
  - [ ] Add visual indicator (orange color, icon)
  - [ ] Display clear message
  - [ ] Ensure feedback appears immediately
- [ ] Trigger haptic feedback (AC: 7)
  - [ ] Call triggerPenalty() from haptics service
  - [ ] Ensure haptic completes within 50ms
- [ ] Verify accuracy (AC: 9)
  - [ ] Test penalty detection is 100% accurate
  - [ ] Test score reset to exactly 25
  - [ ] Test edge cases
- [ ] Ensure real-time enforcement (AC: 10, 11)
  - [ ] Penalty applies without delay
  - [ ] All players see penalty on main game screen
  - [ ] Update UI immediately

## Dev Notes

### Project Context
This story implements the automatic 50+ penalty rule, a key product differentiator. When a player's score exceeds 50, it's automatically reset to 25 with clear feedback.

### Source Tree Information
- **Game rules service**: `services/gameRules.ts` - checkPenaltyRule() function
- **Haptics service**: `services/haptics.ts` - triggerPenalty() function
- **Score entry processing**: In score entry components (Stories 3.2, 3.3)
- **Visual feedback**: `components/game/RuleIndicator.tsx` - Rule enforcement indicators
- **Main game screen**: `app/game/[id]/index.tsx` - Where penalty is displayed

### Architecture References
- **Rule Detection**: Uses gameRules.checkPenaltyRule() (Story 1.4)
- **Haptics**: Strong haptic feedback via triggerPenalty() (Story 1.5)
- **Accuracy**: 100% accuracy required (NFR22, NFR24)
- **Performance**: Real-time enforcement without delay (NFR5)
- **Visual Feedback**: Immediate feedback (NFR8)

### Dependencies
- Requires Story 1.4 (Game Rules Service) to be completed
- Requires Story 1.5 (Haptics Service) to be completed
- Requires Stories 3.2 and 3.3 (Score Entry) to be completed
- Integrates with Story 4.4 (Visual Feedback)

### Testing

**Test File Location:**
- Integration tests for penalty rule enforcement
- `services/__tests__/gameRules.test.ts` - Penalty rule tests

**Test Standards:**
- Test penalty detection accuracy (100% coverage)
- Test score reset to 25
- Test visual feedback
- Test haptic feedback
- Test real-time enforcement
- Test edge cases (exactly 50, 51, etc.)
- Mock game rules and haptics services

**Testing Frameworks:**
- Jest for unit testing
- React Native Testing Library for component testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Story created from Epic 4 | PM Agent |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
