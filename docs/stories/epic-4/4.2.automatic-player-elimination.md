# Story 4.2: Automatic Player Elimination

## Status
Complete

## Story

**As a** user,
**I want** players to be automatically eliminated after 3 consecutive misses,
**so that** elimination rules are enforced without manual tracking.

## Acceptance Criteria

1. **Given** a player has consecutive misses tracked (Story 3.7)
2. **When** the player's consecutive_misses reaches 3
3. **Then** the system automatically detects this using checkElimination() (Story 1.4)
4. **And** the player is marked as eliminated in game state only (is_eliminated = true in state, NOT persisted to database)
5. **And** elimination is round-specific - eliminated players are reactivated when the round is finished
6. **And** the player's status is updated in the game state
6. **And** clear visual feedback is provided:
   - Player's name/card is grayed out or marked visually
   - Visual indicator shows the player is eliminated
   - Clear message explaining elimination ("Player eliminated after 3 consecutive misses")
7. **And** haptic feedback is triggered (appropriate pattern for elimination)
9. **And** eliminated players cannot receive further scores in the current round (FR20)
10. **And** when a round is finished (START_NEW_ROUND action), all eliminations are reset and eliminated players can score again in the next round
11. **And** the elimination is 100% accurate (NFR22, NFR24)
12. **And** the rule enforcement happens in real-time without perceptible delay (NFR5)
13. **And** all players can see who has been eliminated on the main game screen

**FRs covered:** FR19, FR20, FR39, NFR5, NFR22, NFR24

## Tasks / Subtasks

- [ ] Implement elimination detection (AC: 2, 3)
  - [ ] Check consecutive_misses after miss tracking
  - [ ] Use checkElimination() from gameRules service
  - [ ] Detect when consecutive_misses >= 3
- [ ] Mark player as eliminated (AC: 4, 5, 6)
  - [ ] Set is_eliminated = true in game state only (NOT in database)
  - [ ] Update GameContext state with ELIMINATE_PLAYER action
  - [ ] Do NOT persist elimination to database (round-specific, resets on round completion)
- [ ] Prevent score entries for eliminated players (AC: 9)
  - [ ] Disable score entry for eliminated players in current round
  - [ ] Check is_eliminated before allowing score entry
  - [ ] Show message if attempting to enter score (explain round-specific elimination)
- [ ] Implement round reset for eliminations (AC: 10)
  - [ ] Ensure START_NEW_ROUND action resets all eliminations
  - [ ] Verify eliminated players can score again after round completion
  - [ ] Test elimination reset on round completion
- [ ] Create visual feedback (AC: 6, 11)
  - [ ] Gray out or mark eliminated players
  - [ ] Add visual indicator
  - [ ] Display clear message
  - [ ] Show on main game screen
- [ ] Trigger haptic feedback (AC: 7)
  - [ ] Call appropriate haptic pattern for elimination
  - [ ] Ensure haptic completes within 50ms
- [ ] Verify accuracy (AC: 11)
  - [ ] Test elimination detection is 100% accurate
  - [ ] Test exactly 3 misses triggers elimination
  - [ ] Test edge cases
- [ ] Ensure real-time enforcement (AC: 12)
  - [ ] Elimination applies without delay
  - [ ] All players see elimination on main game screen

## Dev Notes

### Project Context
This story implements automatic player elimination after 3 consecutive misses. This is a key game rule that must be enforced accurately and automatically.

### Source Tree Information
- **Game rules service**: `services/gameRules.ts` - checkElimination() function
- **Haptics service**: `services/haptics.ts` - Haptic feedback for elimination
- **Miss tracking**: Story 3.7 (Consecutive Miss Tracking)
- **Score entry**: Stories 3.2, 3.3 - Must check is_eliminated (round-specific)
- **Visual feedback**: `components/game/PlayerCard.tsx` - Show eliminated state
- **Main game screen**: `app/game/[id]/index.tsx` - Display eliminated players
- **Round management**: `reducers/gameReducer.ts` - ELIMINATE_PLAYER and START_NEW_ROUND actions
- **State only**: Elimination is NOT persisted to database (round-specific)

### Architecture References
- **Rule Detection**: Uses gameRules.checkElimination() (Story 1.4)
- **Elimination Status**: Stored in game state only (NOT persisted to database) - round-specific
- **Score Prevention**: Eliminated players cannot receive scores in current round (FR20)
- **Round Reset**: Elimination resets when START_NEW_ROUND action is triggered
- **Accuracy**: 100% accuracy required (NFR22, NFR24)
- **Performance**: Real-time enforcement without delay (NFR5)
- **State Management**: ELIMINATE_PLAYER action sets is_eliminated in state, START_NEW_ROUND resets it

### Dependencies
- Requires Story 1.4 (Game Rules Service) to be completed
- Requires Story 1.5 (Haptics Service) to be completed
- Requires Story 1.6 (Game Context) to be completed
- Requires Story 3.7 (Consecutive Miss Tracking) to be completed
- Requires Stories 3.2 and 3.3 (Score Entry) to check is_eliminated
- Requires Story 2.3 (Main Game Screen) for round completion functionality
- Integrates with Story 4.4 (Visual Feedback)
- Integrates with Story 6.4 (Display Eliminated Players)

### Testing

**Test File Location:**
- Integration tests for elimination rule enforcement
- `services/__tests__/gameRules.test.ts` - Elimination rule tests

**Test Standards:**
- Test elimination detection accuracy (100% coverage)
- Test player marking as eliminated
- Test score entry prevention for eliminated players
- Test visual feedback
- Test haptic feedback
- Test real-time enforcement
- Test edge cases (exactly 3 misses, reset after score)
- Mock game rules and haptics services

**Testing Frameworks:**
- Jest for unit testing
- React Native Testing Library for component testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Story created from Epic 4 | PM Agent |
| 2026-01-18 | 2.0 | Updated to reflect round-specific elimination (not persisted to DB) | SM Agent |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
