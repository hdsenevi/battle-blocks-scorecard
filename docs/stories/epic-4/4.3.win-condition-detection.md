# Story 4.3: Win Condition Detection

## Status
Draft

## Story

**As a** user,
**I want** the system to automatically detect when a player reaches exactly 50 points,
**so that** the game can end automatically when someone wins.

## Acceptance Criteria

1. **Given** a player's score is being updated (Stories 3.2, 3.3)
2. **When** the new score equals exactly 50 points
3. **Then** the system automatically detects this using checkWinCondition() (Story 1.4)
4. **And** the win condition is flagged in the game state
5. **And** the system prevents scores that would exceed 50 without triggering penalty (FR22)
6. **And** the win detection is 100% accurate (NFR22, NFR24)
7. **And** the detection happens in real-time without perceptible delay (NFR5)
8. **And** the win condition triggers the game completion flow (Epic 5, Story 5.1)
9. **And** if a score would exceed 50, the penalty rule (Story 4.1) applies instead
10. **And** a Maestro automation test flow is created in `.maestro/flows/` that:
    - Launches the app, creates a new game, adds at least 2 players, and navigates to the main game screen
    - Enters scores for a player to reach exactly 50 points
    - Verifies the system automatically detects the win condition (exactly 50 points)
    - Verifies the win condition is flagged in the game state
    - Verifies the system prevents scores that would exceed 50 without triggering penalty
    - Verifies the win detection is 100% accurate
    - Verifies the detection happens in real-time without perceptible delay
    - Verifies the win condition triggers the game completion flow (navigates to winner announcement screen)
    - Verifies if a score would exceed 50, the penalty rule applies instead
    - The test flow is added to the automation regression suite

**FRs covered:** FR21, FR22, FR41, NFR5, NFR22, NFR24

## Tasks / Subtasks

- [ ] Implement win condition detection (AC: 2, 3)
  - [ ] Check score after update using checkWinCondition() from gameRules service
  - [ ] Detect when score equals exactly 50
- [ ] Flag win condition in game state (AC: 4)
  - [ ] Update GameContext with win condition
  - [ ] Store winner information
- [ ] Prevent scores exceeding 50 (AC: 5, 9)
  - [ ] Check if score would exceed 50 before applying
  - [ ] If would exceed 50, trigger penalty rule instead
  - [ ] Ensure win condition (exactly 50) is reached correctly
- [ ] Verify accuracy (AC: 6)
  - [ ] Test win detection is 100% accurate
  - [ ] Test exactly 50 triggers win
  - [ ] Test 49, 50, 51 edge cases
- [ ] Ensure real-time detection (AC: 7)
  - [ ] Win detection happens without delay
  - [ ] Immediate flagging of win condition
- [ ] Trigger game completion flow (AC: 8)
  - [ ] Navigate to winner announcement screen (Story 5.1)
  - [ ] Pass winner information
  - [ ] Mark game as completed

## Dev Notes

### Project Context
This story implements automatic win condition detection. When a player reaches exactly 50 points, the game should automatically detect this and trigger the completion flow.

### Source Tree Information
- **Game rules service**: `services/gameRules.ts` - checkWinCondition() function
- **Score entry processing**: In score entry components (Stories 3.2, 3.3)
- **Game Context**: `contexts/GameContext.tsx` - Win condition flagging
- **Game completion**: Epic 5, Story 5.1 (Winner Announcement)

### Architecture References
- **Rule Detection**: Uses gameRules.checkWinCondition() (Story 1.4)
- **Score Prevention**: Prevents scores exceeding 50 without penalty
- **Accuracy**: 100% accuracy required (NFR22, NFR24)
- **Performance**: Real-time detection without delay (NFR5)
- **Game Completion**: Triggers Epic 5 completion flow

### Dependencies
- Requires Story 1.4 (Game Rules Service) to be completed
- Requires Stories 3.2 and 3.3 (Score Entry) to be completed
- Requires Story 1.6 (Game Context) to be completed
- Triggers Story 5.1 (Winner Announcement)
- Integrates with Story 4.1 (Penalty Rule)

### Testing

**Test File Location:**
- Integration tests for win condition detection
- `services/__tests__/gameRules.test.ts` - Win condition tests

**Test Standards:**
- Test win detection accuracy (100% coverage)
- Test exactly 50 triggers win
- Test score prevention (exceeding 50 triggers penalty)
- Test game completion flow trigger
- Test edge cases (49, 50, 51)
- Test real-time detection
- Mock game rules service

**Testing Frameworks:**
- Jest for unit testing
- React Native Testing Library for component testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Story created from Epic 4 | PM Agent |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
