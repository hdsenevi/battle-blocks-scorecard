# Story 1.3: Implement Database Service Layer

## Status
Draft

## Story

**As a** developer,
**I want** to create a database service layer that provides CRUD operations for games, players, and score entries,
**so that** all database interactions are centralized and follow consistent patterns.

## Acceptance Criteria

1. **Given** the database schema is set up (Story 1.2)
2. **When** I use the database service
3. **Then** the service provides functions for:
   - Game operations: createGame(), getGame(), updateGame(), listActiveGames(), listCompletedGames()
   - Player operations: addPlayer(), getPlayer(), updatePlayer(), getPlayersByGame()
   - Score entry operations: addScoreEntry(), getScoreEntriesByPlayer(), getScoreEntriesByGame()
4. **And** all database operations use parameterized queries (no SQL injection risks)
5. **And** all operations include proper error handling with DatabaseError class
6. **And** multi-step operations (e.g., creating game + players) use database transactions
7. **And** the service is located at `services/database.ts` as per architecture
8. **And** the service exports TypeScript interfaces for all data types

**FRs covered:** FR24, FR25, FR26, FR27, FR28, FR29, FR57, FR58

## Tasks / Subtasks

- [ ] Create DatabaseError class (AC: 5)
  - [ ] Create custom DatabaseError class extending Error
  - [ ] Include error code and details properties
- [ ] Implement game operations (AC: 3)
  - [ ] Implement createGame() with parameterized query
  - [ ] Implement getGame() with parameterized query
  - [ ] Implement updateGame() with parameterized query
  - [ ] Implement listActiveGames() with parameterized query
  - [ ] Implement listCompletedGames() with parameterized query
- [ ] Implement player operations (AC: 3)
  - [ ] Implement addPlayer() with parameterized query
  - [ ] Implement getPlayer() with parameterized query
  - [ ] Implement updatePlayer() with parameterized query
  - [ ] Implement getPlayersByGame() with parameterized query
- [ ] Implement score entry operations (AC: 3)
  - [ ] Implement addScoreEntry() with parameterized query
  - [ ] Implement getScoreEntriesByPlayer() with parameterized query
  - [ ] Implement getScoreEntriesByGame() with parameterized query
- [ ] Implement transaction support (AC: 6)
  - [ ] Create transaction wrapper function
  - [ ] Use transactions for multi-step operations (e.g., createGame + addPlayer)
- [ ] Export TypeScript interfaces (AC: 8)
  - [ ] Export Game, Player, ScoreEntry interfaces
  - [ ] Export function return types
- [ ] Add error handling to all operations (AC: 4, 5)
  - [ ] Wrap all database operations in try-catch
  - [ ] Throw DatabaseError with appropriate messages
  - [ ] Ensure all queries use parameterized statements

## Dev Notes

### Project Context
This story implements the database service layer that will be used throughout the app for all database operations. It provides a clean abstraction over SQLite operations.

### Source Tree Information
- **Database service**: `services/database.ts` - Main database service file
- **Database types**: `types/database.ts` - TypeScript interfaces for database entities
- **Error handling**: DatabaseError class in `services/database.ts` or separate error file

### Architecture References
- **Service Location**: `services/database.ts` as per architecture
- **Naming Convention**: camelCase for functions (e.g., `createGame()`, `addPlayer()`)
- **Queries**: Always use parameterized queries for security (no string concatenation)
- **Transactions**: Use transactions for multi-step operations
- **Error Handling**: Custom DatabaseError class extending Error
- **Type Safety**: Export TypeScript interfaces for all data types

### Dependencies
- Requires Story 1.2 to be completed (database schema must exist)
- Uses expo-sqlite for database access

### Testing

**Test File Location:**
- `services/__tests__/database.test.ts` - Database service tests

**Test Standards:**
- Test all CRUD operations for games, players, and score entries
- Test parameterized queries prevent SQL injection
- Test error handling with DatabaseError
- Test transaction rollback on errors
- Test transaction commit on success
- Mock expo-sqlite for unit testing
- Test edge cases (not found, invalid data, etc.)

**Testing Frameworks:**
- Jest for unit testing
- Mock expo-sqlite database for isolated testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Story created from Epic 1 | PM Agent |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
