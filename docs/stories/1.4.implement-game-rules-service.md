# Story 1.4: Implement Game Rules Service

## Status
Ready for Review

## Story

**As a** developer,
**I want** to create pure functions for game rule enforcement logic,
**so that** rule enforcement is 100% accurate, testable, and separated from UI components.

## Acceptance Criteria

1. **Given** the game rules service is implemented
2. **When** I call the rule enforcement functions
3. **Then** the service provides pure functions:
   - `checkPenaltyRule(score: number): boolean` - Returns true if score exceeds 50
   - `checkElimination(consecutiveMisses: number): boolean` - Returns true if 3+ consecutive misses
   - `checkWinCondition(score: number): boolean` - Returns true if exactly 50 points
   - `calculateScore(blocks: number[], isMultiple: boolean): number` - Calculates score (single block = number, multiple = count)
4. **And** all functions are pure (no side effects, no React dependencies)
5. **And** all functions have comprehensive unit tests with 100% coverage
6. **And** the service is located at `services/gameRules.ts` as per architecture
7. **And** functions are type-safe with TypeScript interfaces
8. **And** edge cases are handled (zero blocks, negative values, etc.)

**FRs covered:** FR16, FR17, FR18, FR19, FR21, FR22, FR23, NFR22, NFR23, NFR24

## Tasks / Subtasks

- [x] Create gameRules.ts service file (AC: 6)
  - [x] Create `services/gameRules.ts`
  - [x] Set up TypeScript interfaces for function parameters and returns
- [x] Implement checkPenaltyRule() function (AC: 3)
  - [x] Function takes score: number parameter
  - [x] Returns true if score > 50, false otherwise
  - [x] Handle edge cases (exactly 50, negative values)
- [x] Implement checkElimination() function (AC: 3)
  - [x] Function takes consecutiveMisses: number parameter
  - [x] Returns true if consecutiveMisses >= 3, false otherwise
  - [x] Handle edge cases (0, negative values)
- [x] Implement checkWinCondition() function (AC: 3)
  - [x] Function takes score: number parameter
  - [x] Returns true if score === 50, false otherwise
  - [x] Handle edge cases (above/below 50)
- [x] Implement calculateScore() function (AC: 3)
  - [x] Function takes blocks: number[] and isMultiple: boolean parameters
  - [x] If isMultiple is false: return the single block number value
  - [x] If isMultiple is true: return the count of blocks
  - [x] Handle edge cases (empty array, zero blocks, negative values)
- [x] Ensure all functions are pure (AC: 4)
  - [x] No side effects
  - [x] No React dependencies
  - [x] No external state access
- [x] Write comprehensive unit tests (AC: 5)
  - [x] Test checkPenaltyRule() with all edge cases
  - [x] Test checkElimination() with all edge cases
  - [x] Test checkWinCondition() with all edge cases
  - [x] Test calculateScore() with all edge cases
  - [x] Achieve 100% code coverage

## Dev Notes

### Project Context
This story implements the core game rules logic as pure functions. These functions are critical for game accuracy and must be 100% testable with no dependencies on React or external state.

### Source Tree Information
- **Game rules service**: `services/gameRules.ts` - Pure functions for rule enforcement
- **Test file**: `services/__tests__/gameRules.test.ts` - Comprehensive unit tests

### Architecture References
- **Service Location**: `services/gameRules.ts` as per architecture
- **Function Naming**: camelCase (e.g., `checkPenaltyRule()`, `calculateScore()`)
- **Purity Requirement**: All functions must be pure (no side effects, no React dependencies)
- **Test Coverage**: 100% coverage required (critical for rule accuracy)
- **Type Safety**: TypeScript interfaces for all function parameters and returns

### Game Rules Logic
- **Penalty Rule**: Score exceeding 50 triggers penalty (score > 50)
- **Elimination Rule**: 3 or more consecutive misses eliminates player (consecutiveMisses >= 3)
- **Win Condition**: Exactly 50 points wins the game (score === 50)
- **Score Calculation**: 
  - Single block: use the block number value
  - Multiple blocks: use the count of blocks

### Testing

**Test File Location:**
- `services/__tests__/gameRules.test.ts` - Game rules service tests

**Test Standards:**
- **100% code coverage required** (critical for rule accuracy)
- Test all functions with normal cases
- Test all edge cases:
  - Zero values
  - Negative values
  - Boundary conditions (exactly 50, exactly 3 misses, etc.)
  - Empty arrays for calculateScore
  - Single vs multiple block scenarios
- Test function purity (no side effects)
- Test type safety

**Testing Frameworks:**
- Jest for unit testing
- No mocking required (pure functions)

**Critical Testing Requirements:**
- This is a critical service - rule enforcement must be 100% accurate
- All edge cases must be tested
- 100% code coverage is mandatory

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Story created from Epic 1 | PM Agent |
| 2026-01-14 | 1.1 | Story implementation completed - all pure functions and comprehensive tests | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None

### Completion Notes List
- All story requirements have been implemented and verified
- Game rules service created at `services/gameRules.ts` with all four pure functions
- `checkPenaltyRule(score: number): boolean` - Returns true if score > 50, handles edge cases (exactly 50, negative values, floating point)
- `checkElimination(consecutiveMisses: number): boolean` - Returns true if consecutiveMisses >= 3, handles edge cases (0, negative values, floating point)
- `checkWinCondition(score: number): boolean` - Returns true if score === 50, handles edge cases (above/below 50, negative values, floating point)
- `calculateScore(blocks: number[], isMultiple: boolean): number` - Calculates score based on mode:
  - Single block mode (isMultiple=false): returns the first valid block number value
  - Multiple blocks mode (isMultiple=true): returns the count of valid blocks
  - Handles edge cases: empty arrays, zero blocks, negative values, NaN values, null/undefined (defensive)
- All functions are pure (no side effects, no React dependencies, no external state access)
- Functions do not mutate input arrays (verified in tests)
- Comprehensive test suite created at `services/__tests__/gameRules.test.ts` with 100% code coverage
- Tests cover all normal cases, edge cases, boundary conditions, and function purity
- All functions are type-safe with TypeScript (no `any` types)
- Linting passes with no errors

### File List
- `services/gameRules.ts` - Game rules service with all four pure functions
- `services/__tests__/gameRules.test.ts` - Comprehensive test suite with 100% coverage

## QA Results
_To be populated by QA Agent_
